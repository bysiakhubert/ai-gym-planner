---
import Layout from "@/layouts/Layout.astro";
import type { SessionStructure, SessionSet } from "@/types";
import { planService, PlanNotFoundError } from "@/lib/services/planService";
import {
  sessionService,
  ActiveSessionConflictError,
  WorkoutAlreadyCompletedError,
} from "@/lib/services/sessionService";

export const prerender = false;

// Get query parameters
const planId = Astro.url.searchParams.get("planId");
const date = Astro.url.searchParams.get("date");

// Validate required parameters
if (!planId || !date) {
  return Astro.redirect("/?error=missing_params");
}

// Check authentication
const { supabase, user } = Astro.locals;

if (!user) {
  return Astro.redirect("/login");
}

const userId = user.id;

let errorMessage: string | undefined;

try {
  // Step 1: Fetch the plan to get workout data using planService
  const plan = await planService.getPlanById(supabase, userId, planId);

  // Step 2: Find the workout day for the given date
  const workoutDay = plan.plan.schedule[date];

  if (!workoutDay) {
    return Astro.redirect(`/plans/${planId}?error=no_workout_for_date`);
  }

  // Step 2b: Check if workout is already completed
  if (workoutDay.done) {
    return Astro.redirect(`/plans/${planId}?error=workout_already_completed`);
  }

  // Step 3: Transform workout data to session structure
  const sessionStructure: SessionStructure = {
    plan_name: plan.name,
    day_name: workoutDay.name,
    date: date,
    exercises: workoutDay.exercises.map((exercise) => ({
      name: exercise.name,
      sets: exercise.sets.map(
        (set): SessionSet => ({
          planned_reps: set.reps,
          planned_weight: set.weight,
          actual_reps: null,
          actual_weight: null,
          rest_seconds: set.rest_seconds,
          completed: false,
        })
      ),
    })),
  };

  // Step 4: Create the session using sessionService
  try {
    await sessionService.create(supabase, userId, {
      plan_id: planId,
      date: date,
      session: sessionStructure,
    });

    // Session created successfully - redirect to active session
    return Astro.redirect("/session/active");
  } catch (sessionError) {
    // Check if there's already an active session
    if (sessionError instanceof ActiveSessionConflictError) {
      // Redirect to conflict resolution page with context about requested session
      return Astro.redirect(`/sessions/conflict?planId=${planId}&date=${date}`);
    }

    if (sessionError instanceof WorkoutAlreadyCompletedError) {
      return Astro.redirect(`/plans/${planId}?error=workout_already_completed`);
    }

    throw sessionError;
  }
} catch (error) {
  console.error("Session start error:", error);

  // Handle plan not found error
  if (error instanceof PlanNotFoundError) {
    return Astro.redirect("/?error=plan_not_found");
  }

  errorMessage = "Wystąpił błąd podczas rozpoczynania sesji treningowej.";
}
---

<Layout title="GymPlanner - Rozpocznij trening">
  <div class="container mx-auto px-4 py-8">
    <div class="max-w-lg mx-auto">
      <div class="bg-destructive/10 border border-destructive rounded-lg p-6 text-center">
        <h1 class="text-xl font-semibold text-destructive mb-2">Błąd rozpoczęcia treningu</h1>
        <p class="text-muted-foreground mb-4">{errorMessage}</p>
        <a
          href="/"
          class="inline-flex items-center justify-center rounded-md text-sm font-medium bg-primary text-primary-foreground h-10 px-4 py-2 hover:bg-primary/90"
        >
          Wróć do pulpitu
        </a>
      </div>
    </div>
  </div>
</Layout>
