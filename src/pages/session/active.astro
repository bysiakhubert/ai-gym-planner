---
import Layout from "@/layouts/Layout.astro";
import { ActiveSessionView } from "@/components/session/ActiveSessionView";
import type { SessionResponse } from "@/types";
import { sessionService } from "@/lib/services/sessionService";

export const prerender = false;

// Check authentication
const { supabase, user } = Astro.locals;

if (!user) {
  return Astro.redirect("/login");
}

const userId = user.id;

let sessionData: SessionResponse | null = null;
let errorMessage: string | undefined;

try {
  // Fetch active (uncompleted) session using sessionService
  const sessions = await sessionService.list(supabase, userId, {
    completed: false,
    limit: 1,
    sort: "started_at",
    order: "desc",
  });

  if (sessions.sessions.length === 0) {
    // No active session - redirect to dashboard
    return Astro.redirect("/?message=no_active_session");
  }

  // Get full session details
  const sessionId = sessions.sessions[0].id;
  sessionData = await sessionService.getById(supabase, userId, sessionId);
} catch (error) {
  console.error("Session fetch error:", error);
  errorMessage = "Wystąpił błąd podczas ładowania sesji treningowej.";
}

// If no session data and no error, something went wrong
if (!sessionData && !errorMessage) {
  return Astro.redirect("/?message=session_error");
}
---

<Layout title="GymPlanner - Sesja Treningowa" hideNavigation={true}>
  <ActiveSessionView client:only="react" initialSession={sessionData} error={errorMessage} />
</Layout>
